<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Interactive Cleaning Process Flashcards</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial; }

    /* Card */
    .flashcard { perspective: 1200px; width: 360px; height: 540px; }
    .card-inner { position: relative; width: 100%; height: 100%; transform-style: preserve-3d; transition: transform .6s; }
    .is-flipped .card-inner { transform: rotateY(180deg); }
    .card-face { position: absolute; inset: 0; backface-visibility: hidden; border-radius: 18px; box-shadow: 0 10px 25px rgba(0,0,0,.18); }
    .card-back { transform: rotateY(180deg); }

    /* One card per row, centered */
    #cardsGrid { display: grid; grid-template-columns: 1fr; gap: 2rem 0; place-items: center; }
    .card-wrap { margin-inline: 1rem; position: relative; }

    /* Overlay duplicate button (per card) */
    .dup-overlay {
      position: absolute; top: 8px; right: 8px; z-index: 10;
      opacity: 0; transition: opacity .2s ease;
      background: rgba(15, 23, 42, .75); color: #fff;
      border-radius: 9999px; padding: 6px 10px; font-size: 12px;
      display: flex; align-items: center; gap: 6px;
      box-shadow: 0 4px 10px rgba(0,0,0,.25);
      backdrop-filter: blur(2px);
    }
    .dup-overlay svg { width: 14px; height: 14px; }
    .card-wrap:hover .dup-overlay { opacity: 1; }
    .dup-overlay:focus { opacity: 1; outline: 2px solid #22d3ee; }

    /* Structure hooks for offsets */
    .back-outer{ display:flex; flex-direction:column; height:100%; justify-content:center; }
    .processTitle{ position: relative; }
    .back-content{ position: relative; }
    .frontTitle{ position: relative; }
    .front-content{ position: relative; }

    /* Editor look */
    #editor label { color: #334155; font-size: .9rem; font-weight: 500; }
    #editor input, #editor textarea, #editor select { background-color: #f8fafc; color: #0f172a; width: 100%; }
    #editor textarea { resize: vertical; min-height: 3.5rem; }
    .dark #editor input, .dark #editor textarea, .dark #editor select { background-color: #0b1220; color: #e5e7eb; border-color: #374151; }

    .editor-grid { display: grid; grid-template-columns: 1fr; gap: 12px; align-items: start; }
    .subgrid-3 { display: grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap: 8px; align-items: start; }
    .thumb { width: 70px; height: 70px; object-fit: contain; border-radius: .375rem; background:#f8fafc; border: 1px solid #e5e7eb; }

    /* Compact file button */
    input[type="file"].file-compact { font-size: .75rem; padding: .25rem .5rem; }
    input[type="file"].file-compact::file-selector-button,
    input[type="file"].file-compact::-webkit-file-upload-button {
      padding: .25rem .5rem; font-size: .75rem; border-radius: .375rem; border: 1px solid #cbd5e1; background: #f1f5f9; color: #0f172a;
    }
    .dark input[type="file"].file-compact::file-selector-button,
    .dark input[type="file"].file-compact::-webkit-file-upload-button { background:#111827; color:#e5e7eb; border-color:#374151; }

    /* Checklist (screen) */
    .checklist .chk-row{ display: grid; grid-template-columns: 1fr 18px; align-items: center; gap: 8px; margin: 2px 0; }
    .checklist .chk-text{ font-size: 0.875rem; line-height: 1.25rem; white-space: pre-wrap; }
    .checklist .chk-box{ width: 14px; height: 14px; border: 2px solid rgba(255,255,255,0.9); border-radius: 3px; justify-self: end; background: transparent; }

    /* Print */
    @media print {
      html, body { background: #fff !important; }
      .no-print { display: none !important; }
      #cardsGrid { display: block !important; }
      .card-wrap { margin: 0 auto 24px auto !important; }
      .flashcard { break-inside: avoid; page-break-inside: avoid; }
      .card-inner { transform: none !important; }
      .card-face { position: static !important; transform: none !important; box-shadow: none !important; }
      .print-hide, .dup-overlay { display: none !important; }
    }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 text-slate-800">
  <div class="max-w-7xl mx-auto p-6">
    <header class="no-print flex flex-col gap-3 md:flex-row md:items-center md:justify-between mb-6">
      <div>
        <h1 class="text-3xl font-bold">Cleaning Process Flashcards</h1>
        <p class="text-slate-600">Create, study, duplicate, print. Fully client-side.</p>
      </div>
      <div class="flex flex-wrap gap-2 items-center">
        <button id="addCardBtn" class="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700">Add Card</button>
        <button id="duplicateBtn" class="px-4 py-2 rounded-lg bg-sky-600 text-white hover:bg-sky-700">Duplicate Selected</button>
        <button id="studyBtn" class="px-4 py-2 rounded-lg bg-purple-600 text-white hover:bg-purple-700">Study Mode</button>
        <button id="printSelectedBtn" class="px-4 py-2 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700">Print Selected</button>
        <button id="selfTestBtn" class="px-4 py-2 rounded-lg bg-amber-500 text-white hover:bg-amber-600">Run Self-Tests</button>
      </div>
    </header>

    <section class="no-print grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Editor -->
      <aside class="lg:col-span-1 bg-white rounded-2xl shadow p-5" id="editor">
        <h2 class="text-xl font-semibold mb-4">Edit Card</h2>

        <div class="editor-grid">
          <!-- Flashcard Size (per-card) -->
          <div class="p-3 rounded-lg border border-slate-200 bg-slate-50">
            <div class="flex flex-col gap-3">
              <div class="flex items-center gap-2">
                <label for="f_sizePreset" class="font-medium">Flashcard Size</label>
                <select id="f_sizePreset" class="px-2 py-1 border rounded-md">
                  <option value="default">Default (360×540)</option>
                  <option value="small">Small (320×480)</option>
                  <option value="medium">Medium (400×600)</option>
                  <option value="large">Large (450×675)</option>
                  <option value="custom">Custom…</option>
                </select>
                <label class="ml-auto text-xs flex items-center gap-2">
                  <input id="f_lockRatio" type="checkbox" class="accent-blue-600" checked />
                  Lock 2:3
                </label>
              </div>
              <div class="grid grid-cols-2 gap-3">
                <div>
                  <label class="block text-xs mb-1" for="f_cardW">Width (px)</label>
                  <input id="f_cardW" type="number" min="260" max="800" step="1" class="px-2 py-1 border rounded-md" />
                </div>
                <div>
                  <label class="block text-xs mb-1" for="f_cardH">Height (px)</label>
                  <input id="f_cardH" type="number" min="390" max="1200" step="1" class="px-2 py-1 border rounded-md" />
                </div>
              </div>
              <div class="flex gap-2">
                <button id="applySizeBtn" class="px-3 py-1.5 rounded-md bg-slate-800 text-white">Apply Size</button>
                <button id="resetSizeBtn" class="px-3 py-1.5 rounded-md border">Reset</button>
              </div>
              <p class="text-xs text-slate-500">Per-card size; affects preview & printing (front/back on Letter).</p>
            </div>
          </div>

          <div>
            <label class="block mb-1" for="f_title">Process Name</label>
            <input id="f_title" class="px-3 py-2 border rounded-md" placeholder="Bathroom Cleaning" />
          </div>

          <div>
            <label class="block mb-1" for="f_desc">Description</label>
            <textarea id="f_desc" rows="3" class="px-3 py-2 border rounded-md" placeholder="Short description"></textarea>
          </div>

          <div>
            <label class="block mb-1" for="f_color">Card Color</label>
            <select id="f_color" class="px-3 py-2 border rounded-md w-full">
              <option value="blue">Blue</option>
              <option value="green">Green</option>
              <option value="indigo">Indigo</option>
              <option value="purple">Purple</option>
              <option value="red">Red</option>
              <option value="yellow">Yellow</option>
            </select>
          </div>

          <!-- Icon -->
          <div class="subgrid-3">
            <div><label class="block mb-1" for="f_iconUpload">Icon</label></div>
            <div><input id="f_iconUpload" type="file" accept="image/*" class="px-2 py-1 text-sm border rounded-md bg-white w-full file-compact" /></div>
            <div class="flex items-start gap-2"><img id="iconPreview" class="thumb hidden" alt="Icon preview" /></div>
            <div></div>
            <div class="flex items-center gap-3">
              <label class="text-xs flex items-center gap-2"><input id="f_iconShow" type="checkbox" class="accent-blue-600" checked /> Show</label>
              <button id="clearIconBtn" class="text-xs px-2 py-1 border rounded hidden">Remove</button>
            </div>
          </div>

          <div>
            <label class="block mb-1" for="f_iconSize">Icon Size (px)</label>
            <div class="flex items-center gap-3">
              <input id="f_iconSize" type="range" min="32" max="128" value="70" class="w-full">
              <input id="f_iconSizeNum" type="number" min="32" max="128" value="70" class="w-20 px-2 py-1 border rounded-md">
            </div>
          </div>

          <!-- QR -->
          <div class="subgrid-3">
            <div><label class="block mb-1" for="f_qrupload">QR Code</label></div>
            <div><input id="f_qrupload" type="file" accept="image/*" class="px-2 py-1 text-sm border rounded-md bg-white w-full file-compact" /></div>
            <div class="flex items-start gap-2"><img id="qrPreview" class="thumb hidden" alt="QR preview" /></div>
            <div></div>
            <div class="flex items-center gap-3">
              <label class="text-xs flex items-center gap-2"><input id="f_qrShow" type="checkbox" class="accent-blue-600" checked /> Show</label>
              <button id="clearQrBtn" class="text-xs px-2 py-1 border rounded hidden">Remove</button>
            </div>
          </div>

          <div>
            <label class="block mb-1" for="f_qrSize">QR Size (px)</label>
            <div class="flex items-center gap-3">
              <input id="f_qrSize" type="range" min="48" max="200" value="106" class="w-full">
              <input id="f_qrSizeNum" type="number" min="48" max="200" value="106" class="w-20 px-2 py-1 border rounded-md">
            </div>
          </div>

          <!-- Front caption -->
          <div>
            <label class="block mb-1" for="f_caption">Front Caption (under QR)</label>
            <input id="f_caption" class="px-3 py-2 border rounded-md" placeholder="Scan for details" />
          </div>

          <!-- Front layout controls -->
          <div>
            <div class="flex items-center justify-between">
              <label class="block mb-1" for="f_frontTitleOffset">Front Title Offset (%)</label>
              <button id="resetFrontTitleOffset" class="text-xs px-2 py-1 border rounded">Reset</button>
            </div>
            <div class="flex items-center gap-3">
              <input id="f_frontTitleOffset" type="range" min="-40" max="40" value="0" class="w-full">
              <input id="f_frontTitleOffsetNum" type="number" min="-40" max="40" value="0" class="w-20 px-2 py-1 border rounded-md">
            </div>
            <p class="text-xs text-slate-500 mt-1">Moves the big title on the front. Negative = up.</p>
          </div>

          <div>
            <div class="flex items-center justify-between">
              <label class="block mb-1" for="f_frontContentOffset">Front Content Offset (%)</label>
              <button id="resetFrontContentOffset" class="text-xs px-2 py-1 border rounded">Reset</button>
            </div>
            <div class="flex items-center gap-3">
              <input id="f_frontContentOffset" type="range" min="-40" max="40" value="0" class="w-full">
              <input id="f_frontContentOffsetNum" type="number" min="-40" max="40" value="0" class="w-20 px-2 py-1 border rounded-md">
            </div>
            <p class="text-xs text-slate-500 mt-1">Moves desc + QR + caption together. Negative = up.</p>
          </div>

          <!-- Back layout controls -->
          <div>
            <div class="flex items-center justify-between">
              <label class="block mb-1" for="f_titleOffset">Back Title Offset (%)</label>
              <button id="resetTitleOffset" class="text-xs px-2 py-1 border rounded">Reset</button>
            </div>
            <div class="flex items-center gap-3">
              <input id="f_titleOffset" type="range" min="-40" max="40" value="-20" class="w-full">
              <input id="f_titleOffsetNum" type="number" min="-40" max="40" value="-20" class="w-20 px-2 py-1 border rounded-md">
            </div>
            <p class="text-xs text-slate-500 mt-1">Negative = up, Positive = down (title only).</p>
          </div>

          <div>
            <div class="flex items-center justify-between">
              <label class="block mb-1" for="f_contentOffset">Back Content Offset (%)</label>
              <button id="resetContentOffset" class="text-xs px-2 py-1 border rounded">Reset</button>
            </div>
            <div class="flex items-center gap-3">
              <input id="f_contentOffset" type="range" min="-40" max="40" value="0" class="w-full">
              <input id="f_contentOffsetNum" type="number" min="-40" max="40" value="0" class="w-20 px-2 py-1 border rounded-md">
            </div>
            <p class="text-xs text-slate-500 mt-1">Moves the Equipment/Steps/Extra block together.</p>
          </div>

          <!-- Headings and content -->
          <div>
            <label class="block mb-1" for="f_equipLabel">Equipment Heading</label>
            <input id="f_equipLabel" class="px-3 py-2 border rounded-md" placeholder="Equipment List" />
          </div>

          <div>
            <label class="block mb-1" for="f_stepsLabel">Steps Heading</label>
            <input id="f_stepsLabel" class="px-3 py-2 border rounded-md" placeholder="Process Steps" />
          </div>

          <div>
            <label class="block mb-1" for="f_equipment">Equipment List</label>
            <textarea id="f_equipment" rows="4" class="px-3 py-2 border rounded-md" placeholder="• item
• item"></textarea>
          </div>

          <div>
            <label class="block mb-1" for="f_steps">Process Steps</label>
            <textarea id="f_steps" rows="6" class="px-3 py-2 border rounded-md" placeholder="1. step
2. step"></textarea>
          </div>

          <!-- Optional extra section -->
          <div>
            <label class="block mb-1" for="f_extraLabel">Extra Heading (optional)</label>
            <input id="f_extraLabel" class="px-3 py-2 border rounded-md" placeholder="Notes / Safety / Checklist" />
          </div>
          <div>
            <label class="block mb-1" for="f_extraText">Extra Content</label>
            <textarea id="f_extraText" rows="4" class="px-3 py-2 border rounded-md" placeholder="Any additional notes"></textarea>
          </div>
          <div>
            <label class="block text-sm flex items-center gap-2" for="f_extraShow">
              <input id="f_extraShow" type="checkbox" class="accent-blue-600" />
              Show Extra Section
            </label>
          </div>

          <div>
            <div class="flex items-center justify-center gap-2">
              <button id="saveCardBtn" class="px-3 py-2 rounded-md bg-blue-600 text-white hover:bg-blue-700">Save</button>
              <button id="deleteCardBtn" class="px-3 py-2 rounded-md bg-rose-600 text-white hover:bg-rose-700">Delete</button>
            </div>
          </div>
        </div>

        <p class="text-xs text-slate-500 mt-3">Tip: Double-click a card to select it. Press <kbd class="px-1 border rounded">Space</kbd> to flip a focused card.</p>
      </aside>

      <!-- Cards -->
      <main class="lg:col-span-2">
        <div id="cardsGrid" class="grid grid-cols-1 gap-y-8 place-items-center"></div>
      </main>
    </section>

    <section id="diagnostics" class="no-print mt-6 p-4 rounded-lg bg-amber-50 border border-amber-200 text-amber-800 hidden"></section>

    <!-- Study Mode -->
    <section id="studyOverlay" class="fixed inset-0 bg-black/70 backdrop-blur-sm hidden items-center justify-center z-50">
      <div class="w-[380px] md:w-[420px]">
        <div class="flex justify-between items-center mb-3">
          <div class="text-white/80 text-sm" id="progressTxt">1 / 1</div>
          <div class="space-x-2">
            <button id="knownBtn" class="px-3 py-1 rounded bg-emerald-500 text-white">Known</button>
            <button id="unknownBtn" class="px-3 py-1 rounded bg-rose-500 text-white">Retry</button>
            <button id="closeStudyBtn" class="px-3 py-1 rounded bg-slate-700 text-white">Close</button>
          </div>
        </div>
        <div class="flashcard mx-auto select-none" tabindex="0" id="studyCard"></div>
        <div class="mt-4 flex justify-between text-white">
          <button id="prevBtn" class="px-3 py-2 rounded bg-white/10">← Prev</button>
          <button id="flipStudyBtn" class="px-3 py-2 rounded bg-white/10">Flip</button>
          <button id="nextBtn" class="px-3 py-2 rounded bg-white/10">Next →</button>
        </div>
      </div>
    </section>
  </div>

  <!-- Card template -->
  <template id="cardTemplate">
    <div class="card-wrap">
      <!-- Per-card overlay duplicate button -->
      <button type="button" class="dup-overlay no-print" title="Duplicate this card">
        <!-- tiny copy icon -->
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
          <rect x="9" y="9" width="11" height="11" rx="2"></rect>
          <rect x="4" y="4" width="11" height="11" rx="2"></rect>
        </svg>
        Duplicate
      </button>

      <div class="flashcard group" tabindex="0">
        <div class="card-inner">
          <!-- Front -->
          <div class="card-face front text-white p-6 flex flex-col justify-between bg-gradient-to-br from-red-500 to-red-600 rounded-2xl">
            <div class="text-center">
              <div class="mb-4 flex justify-center items-center iconWrap" style="height:70px;">
                <img class="object-contain hidden imgIcon" alt="Icon" style="width:70px;height:70px;" />
              </div>
              <h3 class="text-2xl font-bold title frontTitle">Title</h3>
              <div class="front-content">
                <p class="mt-2 text-sm/5 opacity-90 desc">Description</p>
                <div class="text-center mt-3">
                  <div class="bg-white p-3 rounded-lg inline-flex items-center justify-center mx-auto shadow-inner qrBox" style="width: 7rem; height: 7rem;">
                    <img class="qrImg hidden object-contain" alt="QR" style="width:106px;height:106px;" />
                  </div>
                  <p class="mt-2 text-xs/4 opacity-80 caption">Scan for details</p>
                </div>
              </div>
            </div>
            <div class="text-center text-xs/4 opacity-80 print-hide">Click to flip</div>
          </div>
          <!-- Back -->
          <div class="card-face card-back text-white p-6 bg-gradient-to-br from-red-500 to-red-600 rounded-2xl">
            <div class="back-outer">
              <h4 class="processTitle text-xl font-semibold text-center border-b border-white/50 pb-2 mb-4">Process Details</h4>
              <div class="back-content space-y-4 overflow-auto pr-1" style="max-height: 360px">
                <div>
                  <div class="font-semibold mb-1 equipLabel">Equipment List</div>
                  <div class="bg-white/15 p-3 rounded">
                    <div class="checklist equipmentList"></div>
                  </div>
                </div>
                <div>
                  <div class="font-semibold mb-1 stepsLabel">Process Steps</div>
                  <div class="bg-white/15 p-3 rounded">
                    <div class="checklist stepsList"></div>
                  </div>
                </div>
                <div class="extraSection hidden">
                  <div class="font-semibold mb-1 extraLabel">Extra</div>
                  <div class="bg-white/15 p-3 rounded">
                    <div class="checklist extraList"></div>
                  </div>
                </div>
              </div>
              <div class="mt-3 text-center text-xs/4 opacity-80 print-hide">Click to flip back</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </template>

  <script>
    /* ======= Config for print fine-tuning ======= */
    const PRINT_SAFE_INSET = '6mm';
    const PRINT_OFFSETS = { front:{dx:'0mm',dy:'0mm'}, back:{dx:'0mm',dy:'0mm'} };

    /* ========= helpers & state ========= */
    const $ = (q, el=document) => el.querySelector(q);
    const $$ = (q, el=document) => [...el.querySelectorAll(q)];

    const colorSchemes = {
      blue:   { from: 'from-blue-500',   to: 'to-blue-600' },
      green:  { from: 'from-green-500',  to: 'to-green-600' },
      indigo: { from: 'from-indigo-500', to: 'to-indigo-600' },
      purple: { from: 'from-purple-500', to: 'to-purple-600' },
      red:    { from: 'from-red-500',    to: 'to-red-600' },
      yellow: { from: 'from-yellow-500', to: 'to-yellow-600' },
    };

    const DEFAULT_CARD_W = 360;
    const DEFAULT_CARD_H = 540;

    const ICON_PX_FALLBACK = 70;
    const QR_PX_FALLBACK = 106;

    const FRONT_TITLE_OFFSET_DEFAULT = 0;
    const FRONT_CONTENT_OFFSET_DEFAULT = 0;
    const TITLE_OFFSET_DEFAULT = -20;
    const CONTENT_OFFSET_DEFAULT = 0;

    let cards = [];
    let selectedId = null;
    const _state = { iconImg: '', qrImg: '' };

    function clampNum(v, min, max){ v = Number(v); if (Number.isNaN(v)) v = min; return Math.min(max, Math.max(min, v)); }
    function pctToPx(pct, basePx){ return (Number(pct||0) / 100) * basePx * 0.5; }
    function makeId(){ return Math.random().toString(36).slice(2,9); }

    function ensureSizeFields(card){
      if (typeof card.cardW !== 'number') card.cardW = DEFAULT_CARD_W;
      if (typeof card.cardH !== 'number') card.cardH = DEFAULT_CARD_H;
      if (typeof card.lockRatio !== 'boolean') card.lockRatio = true;
      if (!card.sizePreset) card.sizePreset = 'default';
    }

    function defaultCard(){
      return {
        id: makeId(),
        cardW: DEFAULT_CARD_W,
        cardH: DEFAULT_CARD_H,
        lockRatio: true,
        sizePreset: 'default',

        title: 'Bathroom Cleaning',
        desc: 'Short description of the process',
        color: 'red',
        iconImg: '',
        showIcon: true,
        iconSize: ICON_PX_FALLBACK,
        qrImg: '',
        showQR: true,
        qrSize: QR_PX_FALLBACK,
        caption: 'Scan for details',
        frontTitleOffsetPct: FRONT_TITLE_OFFSET_DEFAULT,
        frontContentOffsetPct: FRONT_CONTENT_OFFSET_DEFAULT,
        titleOffsetPct: TITLE_OFFSET_DEFAULT,
        contentOffsetPct: CONTENT_OFFSET_DEFAULT,
        equipLabel: 'Equipment List',
        stepsLabel: 'Process Steps',
        equipment: '• Disinfectant spray\n• Microfiber cloths',
        steps: '1. Step one\n2. Step two',
        showExtra: false,
        extraLabel: '',
        extraText: ''
      };
    }

    function loadFromLocal(){
      try {
        const raw = localStorage.getItem('cleaning_flashcards_v2');
        if (!raw) { cards = [defaultCard()]; return; }
        const parsed = JSON.parse(raw);
        if (!Array.isArray(parsed) || !parsed.length) { cards = [defaultCard()]; return; }
        cards = parsed;
      } catch (e) { console.warn('Local data invalid, using default.', e); cards = [defaultCard()]; }

      for (const c of cards) {
        if (typeof c.iconSize !== 'number') c.iconSize = ICON_PX_FALLBACK;
        if (typeof c.qrSize !== 'number') c.qrSize = QR_PX_FALLBACK;
        if (!('caption' in c)) c.caption = 'Scan for details';
        if (typeof c.frontTitleOffsetPct !== 'number') c.frontTitleOffsetPct = FRONT_TITLE_OFFSET_DEFAULT;
        if (typeof c.frontContentOffsetPct !== 'number') c.frontContentOffsetPct = FRONT_CONTENT_OFFSET_DEFAULT;
        if (typeof c.titleOffsetPct !== 'number') c.titleOffsetPct = TITLE_OFFSET_DEFAULT;
        if (typeof c.contentOffsetPct !== 'number') c.contentOffsetPct = CONTENT_OFFSET_DEFAULT;
        if (!('showExtra' in c)) c.showExtra = false;
        if (!('extraLabel' in c)) c.extraLabel = '';
        if (!('extraText' in c)) c.extraText = '';
        if (!c.equipLabel) c.equipLabel = 'Equipment List';
        if (!c.stepsLabel) c.stepsLabel = 'Process Steps';
        if (typeof c.showIcon !== 'boolean') c.showIcon = !!c.iconImg;
        if (typeof c.showQR !== 'boolean') c.showQR = !!c.qrImg;
        ensureSizeFields(c);
      }
    }
    function saveToLocal(){ try{ localStorage.setItem('cleaning_flashcards_v2', JSON.stringify(cards)); }catch(_){} }
    function onDataChanged(){ saveToLocal(); }

    function applyColors(el, color){
      const c = colorSchemes[color] || colorSchemes.blue;
      el.classList.remove(...Object.values(colorSchemes).flatMap(s=>['bg-gradient-to-br', s.from, s.to]));
      el.classList.add('bg-gradient-to-br', c.from, c.to);
    }

    /* ===== Checklist ===== */
    function makeChecklist(container, text){
      container.innerHTML = '';
      if(!text) return;
      const lines = String(text).split(/\r?\n/).map(s => {
        return s.replace(/^\s*(?:[\u2022\u2023\u25E6\-–—]|(\d+)[\.)])\s*/, '').trim();
      }).filter(Boolean);
      for(const line of lines){
        const row = document.createElement('div');
        row.className = 'chk-row';
        row.style.display = 'grid';
        row.style.gridTemplateColumns = '1fr 18px';
        row.style.alignItems = 'center';
        row.style.gap = '8px';
        row.style.margin = '3px 0';
        const textSpan = document.createElement('span');
        textSpan.className = 'chk-text';
        textSpan.textContent = line;
        textSpan.style.fontSize = '0.875rem';
        textSpan.style.lineHeight = '1.25rem';
        textSpan.style.whiteSpace = 'pre-wrap';
        textSpan.style.wordBreak = 'break-word';
        textSpan.style.overflowWrap = 'anywhere';
        const box = document.createElement('span');
        box.className = 'chk-box';
        box.setAttribute('aria-hidden', 'true');
        box.style.width = '14px';
        box.style.height = '14px';
        box.style.border = '2px solid rgba(255,255,255,0.9)';
        box.style.borderRadius = '3px';
        box.style.justifySelf = 'end';
        box.style.background = 'transparent';
        row.appendChild(textSpan);
        row.appendChild(box);
        container.appendChild(row);
      }
    }

    /* ===== Render ===== */
    function renderCard(card){
      ensureSizeFields(card);
      const cardW = clampNum(card.cardW, 260, 800);
      const cardH = clampNum(card.cardH, 390, 1200);

      const tpl = document.getElementById('cardTemplate');
      const wrap = tpl.content.firstElementChild.cloneNode(true);
      const node = $('.flashcard', wrap);
      node.style.width = cardW + 'px';
      node.style.height = cardH + 'px';

      const front = $('.card-face.front', wrap);
      const back  = $('.card-face.card-back', wrap);
      const imgIcon = $('.imgIcon', wrap);
      const iconWrap = $('.iconWrap', wrap);
      const qrBox = $('.qrBox', wrap);
      const qrImg = $('.qrImg', wrap);
      const extraSec = $('.extraSection', wrap);
      const backContent = $('.back-content', wrap);
      const frontTitle = $('.frontTitle', wrap);
      const frontContent = $('.front-content', wrap);
      const captionEl = $('.caption', wrap);

      $('.title', wrap).textContent = card.title;
      $('.desc', wrap).textContent = card.desc;
      captionEl.textContent = card.caption || 'Scan for details';
      $('.equipLabel', wrap).textContent = card.equipLabel || 'Equipment List';
      $('.stepsLabel', wrap).textContent = card.stepsLabel || 'Process Steps';
      makeChecklist($('.equipmentList', wrap), card.equipment || '');
      makeChecklist($('.stepsList', wrap), card.steps || '');

      applyColors(front, card.color); applyColors(back, card.color);

      if (backContent) backContent.style.maxHeight = Math.max(120, cardH - 180) + 'px';

      if (frontTitle)   frontTitle.style.transform   = `translateY(${pctToPx(card.frontTitleOffsetPct, cardH)}px)`;
      if (frontContent) frontContent.style.transform = `translateY(${pctToPx(card.frontContentOffsetPct, cardH)}px)`;

      const titleEl = $('.processTitle', wrap);
      if (titleEl) titleEl.style.transform = `translateY(${pctToPx(card.titleOffsetPct, cardH)}px)`;
      if (backContent) backContent.style.transform = `translateY(${pctToPx(card.contentOffsetPct, cardH)}px)`;

      // icon
      const iconSize = clampNum(card.iconSize || ICON_PX_FALLBACK, 32, 128);
      if(card.showIcon && card.iconImg){
        imgIcon.src = card.iconImg;
        imgIcon.style.width = iconSize+'px';
        imgIcon.style.height = iconSize+'px';
        iconWrap.style.height = iconSize+'px';
        imgIcon.classList.remove('hidden'); iconWrap.classList.remove('hidden');
      } else { imgIcon.classList.add('hidden'); iconWrap.classList.add('hidden'); }

      // QR
      const qrSize = clampNum(card.qrSize || QR_PX_FALLBACK, 48, 200);
      if(card.showQR && card.qrImg){
        qrImg.src = card.qrImg; qrImg.classList.remove('hidden'); qrBox.style.display='inline-flex';
        qrImg.style.width = qrSize+'px'; qrImg.style.height = qrSize+'px';
        qrBox.style.width = (qrSize + 10) + 'px';
        qrBox.style.height = (qrSize + 10) + 'px';
      } else { qrImg.classList.add('hidden'); qrBox.style.display='none'; }

      // Extra section
      const showExtra = !!card.showExtra && (!!card.extraLabel || !!card.extraText);
      if (showExtra) {
        $('.extraLabel', wrap).textContent = card.extraLabel || 'Extra';
        makeChecklist($('.extraList', wrap), card.extraText || '');
        extraSec.classList.remove('hidden');
        extraSec.style.display = 'block';
      } else {
        extraSec.classList.add('hidden');
        extraSec.style.display = 'none';
      }

      // interactions
      wrap.addEventListener('click', (e)=>{
        // ignore clicks on overlay duplicate
        if (e.target.closest('.dup-overlay')) return;
        node.classList.toggle('is-flipped');
      });
      wrap.addEventListener('keydown', (e)=>{ if(e.code==='Space'){ e.preventDefault(); node.classList.toggle('is-flipped'); } });
      wrap.addEventListener('dblclick', ()=> selectForEdit(card.id));
      wrap.addEventListener('focusin', ()=> selectForEdit(card.id));

      node.dataset.id = card.id; wrap.dataset.id = card.id;
      return wrap;
    }

    function mountGrid(){
      const grid = document.getElementById('cardsGrid');
      grid.innerHTML='';
      for(const card of cards){ grid.appendChild(renderCard(card)); }
      highlightSelected();
    }

    function selectForEdit(id){
      selectedId = id; const card = cards.find(c=>c.id===id) || cards[0]; if(!card) return;
      ensureSizeFields(card);

      // Size section (per card)
      document.getElementById('f_cardW').value = card.cardW;
      document.getElementById('f_cardH').value = card.cardH;
      document.getElementById('f_lockRatio').checked = !!card.lockRatio;
      document.getElementById('f_sizePreset').value = card.sizePreset || 'custom';

      // Card data
      document.getElementById('f_title').value = card.title;
      document.getElementById('f_desc').value = card.desc;
      document.getElementById('f_color').value = card.color;
      document.getElementById('f_equipment').value = card.equipment || '';
      document.getElementById('f_steps').value = card.steps || '';
      document.getElementById('f_equipLabel').value = card.equipLabel || 'Equipment List';
      document.getElementById('f_stepsLabel').value = card.stepsLabel || 'Process Steps';
      document.getElementById('f_caption').value = card.caption || 'Scan for details';

      document.getElementById('f_iconShow').checked = !!card.showIcon;
      document.getElementById('f_qrShow').checked = !!card.showQR;
      document.getElementById('f_iconSize').value = card.iconSize || ICON_PX_FALLBACK;
      document.getElementById('f_iconSizeNum').value = card.iconSize || ICON_PX_FALLBACK;
      document.getElementById('f_qrSize').value = card.qrSize || QR_PX_FALLBACK;
      document.getElementById('f_qrSizeNum').value = card.qrSize || QR_PX_FALLBACK;

      document.getElementById('f_frontTitleOffset').value = card.frontTitleOffsetPct ?? FRONT_TITLE_OFFSET_DEFAULT;
      document.getElementById('f_frontTitleOffsetNum').value = card.frontTitleOffsetPct ?? FRONT_TITLE_OFFSET_DEFAULT;
      document.getElementById('f_frontContentOffset').value = card.frontContentOffsetPct ?? FRONT_CONTENT_OFFSET_DEFAULT;
      document.getElementById('f_frontContentOffsetNum').value = card.frontContentOffsetPct ?? FRONT_CONTENT_OFFSET_DEFAULT;

      document.getElementById('f_titleOffset').value = card.titleOffsetPct ?? TITLE_OFFSET_DEFAULT;
      document.getElementById('f_titleOffsetNum').value = card.titleOffsetPct ?? TITLE_OFFSET_DEFAULT;
      document.getElementById('f_contentOffset').value = card.contentOffsetPct ?? CONTENT_OFFSET_DEFAULT;
      document.getElementById('f_contentOffsetNum').value = card.contentOffsetPct ?? CONTENT_OFFSET_DEFAULT;

      document.getElementById('f_extraLabel').value = card.extraLabel || '';
      document.getElementById('f_extraText').value = card.extraText || '';
      document.getElementById('f_extraShow').checked = !!card.showExtra;

      const ip = document.getElementById('iconPreview');
      if(card.iconImg){ ip.src = card.iconImg; ip.classList.remove('hidden'); $('#clearIconBtn').classList.remove('hidden'); }
      else { ip.classList.add('hidden'); $('#clearIconBtn').classList.add('hidden'); }

      const qp = document.getElementById('qrPreview');
      if(card.qrImg){ qp.src = card.qrImg; qp.classList.remove('hidden'); $('#clearQrBtn').classList.remove('hidden'); }
      else { qp.classList.add('hidden'); $('#clearQrBtn').classList.add('hidden'); }

      highlightSelected();
    }

    function highlightSelected(){
      $$('#cardsGrid .flashcard').forEach(el=>{
        if(el.dataset.id === selectedId) el.classList.add('ring-4','ring-sky-400');
        else el.classList.remove('ring-4','ring-sky-400');
      });
    }

    function gatherEditor(){
      const iconVal = clampNum(document.getElementById('f_iconSize').value || ICON_PX_FALLBACK, 32, 128);
      const qrVal = clampNum(document.getElementById('f_qrSize').value || QR_PX_FALLBACK, 48, 200);
      const frontTitleOff = clampNum(document.getElementById('f_frontTitleOffset').value ?? FRONT_TITLE_OFFSET_DEFAULT, -40, 40);
      const frontContentOff = clampNum(document.getElementById('f_frontContentOffset').value ?? FRONT_CONTENT_OFFSET_DEFAULT, -40, 40);
      const backTitleOff = clampNum(document.getElementById('f_titleOffset').value ?? TITLE_OFFSET_DEFAULT, -40, 40);
      const backContentOff = clampNum(document.getElementById('f_contentOffset').value ?? CONTENT_OFFSET_DEFAULT, -40, 40);
      return {
        title: document.getElementById('f_title').value.trim() || 'Untitled',
        desc: document.getElementById('f_desc').value.trim(),
        color: document.getElementById('f_color').value,
        caption: document.getElementById('f_caption').value.trim() || 'Scan for details',
        iconImg: _state.iconImg || (cards.find(c=>c.id===selectedId)?.iconImg || ''),
        showIcon: document.getElementById('f_iconShow').checked,
        iconSize: iconVal,
        qrImg: _state.qrImg || (cards.find(c=>c.id===selectedId)?.qrImg || ''),
        showQR: document.getElementById('f_qrShow').checked,
        qrSize: qrVal,
        frontTitleOffsetPct: frontTitleOff,
        frontContentOffsetPct: frontContentOff,
        titleOffsetPct: backTitleOff,
        contentOffsetPct: backContentOff,
        equipLabel: document.getElementById('f_equipLabel').value.trim() || 'Equipment List',
        stepsLabel: document.getElementById('f_stepsLabel').value.trim() || 'Process Steps',
        equipment: document.getElementById('f_equipment').value,
        steps: document.getElementById('f_steps').value,
        extraLabel: document.getElementById('f_extraLabel').value.trim(),
        extraText: document.getElementById('f_extraText').value,
        showExtra: document.getElementById('f_extraShow').checked
      };
    }

    /* ========= system dark mode ========= */
    function applySystemDarkMode(){
      const prefers = window.matchMedia('(prefers-color-scheme: dark)');
      const set = () => {
        document.documentElement.classList.toggle('dark', prefers.matches);
        if (prefers.matches){
          document.body.classList.add('bg-slate-900');
          document.body.classList.remove('bg-gradient-to-br','from-blue-50','to-indigo-100');
        } else {
          document.body.classList.remove('bg-slate-900');
          document.body.classList.add('bg-gradient-to-br','from-blue-50','to-indigo-100');
        }
      };
      try { set(); prefers.addEventListener('change', set); } catch(_) { prefers.addListener && prefers.addListener(set); }
    }

    /* ========= PRINT ========= */
    function prepareFace(origFace){
      const selected = cards.find(c => c.id === selectedId) || cards[0];
      ensureSizeFields(selected);
      const cardW = clampNum(selected.cardW, 260, 800);
      const cardH = clampNum(selected.cardH, 390, 1200);

      const face = origFace.cloneNode(true);

      face.querySelectorAll('.print-hide').forEach(e=> e.remove());

      Object.assign(face.style, {
        display:'flex', flexDirection:'column',
        justifyContent: face.classList.contains('card-back') ? 'flex-start' : 'space-between',
        padding:'24px', borderRadius:'18px',
        width:`${cardW}px`, height:`${cardH}px`, boxSizing:'border-box',
        boxShadow:'none', transform:'none', position:'relative', textAlign:'left', overflow:'hidden'
      });

      face.querySelectorAll('pre').forEach(p => { p.style.whiteSpace = 'pre-wrap'; });
      face.querySelectorAll('.text-center').forEach(w => { w.style.textAlign = 'center'; });

      // FRONT offsets for print
      if (face.classList.contains('front')){
        const screenCard = selected;
        const ft = face.querySelector('.frontTitle');
        const fc = face.querySelector('.front-content');
        if (ft) ft.style.transform = `translateY(${pctToPx(screenCard.frontTitleOffsetPct, cardH)}px)`;
        if (fc) fc.style.transform = `translateY(${pctToPx(screenCard.frontContentOffsetPct, cardH)}px)`;
        const cap = face.querySelector('.caption');
        if (cap) cap.textContent = screenCard.caption || 'Scan for details';
      }

      // BACK offsets for print
      if (face.classList.contains('card-back')) {
        const title = face.querySelector('.processTitle');
        const content = face.querySelector('.back-content');
        const titlePx = pctToPx(selected.titleOffsetPct ?? -20, cardH);
        const contentPx = pctToPx(selected.contentOffsetPct ?? 0, cardH);
        if (title)   title.style.transform   = `translateY(${titlePx}px)`;
        if (content) content.style.transform = `translateY(${contentPx}px)`;
      }

      // ICON
      face.querySelectorAll('.iconWrap').forEach(w=>{
        const img = w.querySelector('img');
        const visible = !w.classList.contains('hidden') && img && img.getAttribute('src');
        if(!visible){ w.remove(); return; }
        const cw = parseInt((img.style.width || getComputedStyle(img).width || '70px'), 10) || 70;
        const ch = parseInt((img.style.height || getComputedStyle(img).height || '70px'), 10) || 70;
        const size = Math.max(cw, ch, 70);
        Object.assign(w.style, { display:'flex', alignItems:'center', justifyContent:'center',
                                 margin:'0 auto', width:size+'px', height:size+'px' });
        Object.assign(img.style, { display:'block', width:'100%', height:'100%', objectFit:'contain' });
      });

      // QR
      face.querySelectorAll('.qrBox').forEach(b=>{
        const img = b.querySelector('img');
        const visible = (b.style.display !== 'none') && img && img.getAttribute('src');
        if(!visible){ b.remove(); return; }
        const wpx = parseInt((img.style.width || '106px'), 10) || 106;
        const hpx = parseInt((img.style.height || getComputedStyle(img).height || '106px'), 10) || 106;
        const size = Math.max(wpx, hpx, 106);
        Object.assign(b.style, { display:'flex', alignItems:'center', justifyContent:'center',
                                 margin:'0 auto', width:(size+10)+'px', height:(size+10)+'px',
                                 borderRadius:'10px', background:'#fff', boxSizing:'border-box' });
        Object.assign(img.style, { display:'block', width:'100%', height:'100%', objectFit:'contain' });
      });

      if (face.classList.contains('card-back')) {
        const bouter = face.querySelector('.back-outer');
        if (bouter){ Object.assign(bouter.style, { display:'flex', flexDirection:'column', height:'100%', justifyContent:'center' }); }

        const scroller = face.querySelector('.back-content');
        if (scroller){
          Object.assign(scroller.style, {
            display:'grid', gridAutoRows:'min-content', rowGap:'12px',
            maxHeight:'none', overflow:'visible', padding:'0', margin:'0', boxSizing:'border-box'
          });
        }

        face.querySelectorAll('.equipLabel, .stepsLabel, .extraLabel').forEach(lbl=>{
          Object.assign(lbl.style, { display:'block', fontWeight:'600', margin:'2px 0 6px 0' });
        });
        face.querySelectorAll('[class*="bg-white/15"]').forEach(box=>{
          Object.assign(box.style, {
            background:'rgba(255,255,255,0.15)', borderRadius:'10px',
            padding:'12px 16px 12px 12px', margin:'0', width:'100%', boxSizing:'border-box'
          });
        });
        face.querySelectorAll('.checklist .chk-row').forEach(r=>{
          r.style.margin = '3px 0';
          const txt = r.querySelector('.chk-text');
          if (txt){ Object.assign(txt.style, { wordBreak:'break-word', overflowWrap:'anywhere' }); }
        });
        const bottomSpacer = document.createElement('div');
        bottomSpacer.style.height = '10px';
        (scroller || face).appendChild(bottomSpacer);
      }

      face.querySelectorAll('.extraSection').forEach(sec=>{
        const cs = getComputedStyle(sec);
        if (sec.classList.contains('hidden') || cs.display === 'none') sec.remove();
      });

      try {
        const cs = getComputedStyle(origFace);
        face.style.backgroundImage = cs.backgroundImage;
        face.style.backgroundColor = cs.backgroundColor;
        face.style.color = cs.color;
      } catch(_) {}

      const inner = document.createElement('div');
      inner.style.transformOrigin = 'top center';
      while (face.firstChild) inner.appendChild(face.firstChild);
      face.appendChild(inner);
      const SAFE_BOTTOM = 8;
      const maxH = face.clientHeight - SAFE_BOTTOM;
      const neededH = inner.scrollHeight;
      if (neededH > maxH) inner.style.transform = `scale(${maxH / neededH})`;

      return face;
    }

    function buildPrintHTML(cardWrap){
      const selected = cards.find(c => c.id === selectedId) || cards[0];
      ensureSizeFields(selected);
      const cardW = clampNum(selected.cardW, 260, 800);
      const cardH = clampNum(selected.cardH, 390, 1200);

      const areaW = '5.5in', areaH = '8.5in';
      const front = prepareFace(cardWrap.querySelector('.card-face.front'));
      const back  = prepareFace(cardWrap.querySelector('.card-face.card-back'));

      const doc = document.implementation.createHTMLDocument('Print Flashcard');
      const head = doc.head, body = doc.body;

      const style = doc.createElement('style');
      style.textContent = `
        *{box-sizing:border-box}
        @page { size: 8.5in 11in; margin: 0; }
        :root{ --safe:${PRINT_SAFE_INSET}; }
        html,body{ margin:0; padding:0; background:#fff; color:#111;
                   -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        body{ font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial; }

        .paper{ width:8.5in; height:11in; display:flex; align-items:center; justify-content:center; page-break-after: always; }
        .paper:last-child{ page-break-after: auto; }

        .fit { width: calc(${areaW} - var(--safe)*2);
               height: calc(${areaH} - var(--safe)*2);
               display:flex; align-items:center; justify-content:center; position:relative; }

        .stage { width:${cardW}px; height:${cardH}px; transform-origin:center center;
                 transform: scale(
                   calc(min(
                     (calc(${areaW} - var(--safe)*2)) / ${cardW}px,
                     (calc(${areaH} - var(--safe)*2)) / ${cardH}px
                   ))
                 );
        }
      `;
      head.appendChild(style);

      function page(face, dx, dy){
        const paper = doc.createElement('div'); paper.className='paper';
        const theFit = doc.createElement('div'); theFit.className='fit';
        const stage = doc.createElement('div'); stage.className='stage';
        if (dx && dx !== '0') { theFit.style.left = dx; theFit.style.position='relative'; }
        if (dy && dy !== '0') { theFit.style.top  = dy; theFit.style.position='relative'; }
        stage.appendChild(face); theFit.appendChild(stage); paper.appendChild(theFit);
        return paper;
      }

      body.appendChild(page(front, PRINT_OFFSETS.front.dx, PRINT_OFFSETS.front.dy));
      body.appendChild(page(back,  PRINT_OFFSETS.back.dx,  PRINT_OFFSETS.back.dy));

      return '<!DOCTYPE html>' + doc.documentElement.outerHTML;
    }

    function printCurrent(){
      const target = (selectedId && document.querySelector(`#cardsGrid .flashcard[data-id="${selectedId}"]`)) || document.querySelector('#cardsGrid .flashcard');
      if(!target){ alert('No card to print. Double-click a card first.'); return; }
      const wrap = target.closest('.card-wrap') || target;

      const html = buildPrintHTML(wrap);
      const ifr = document.createElement('iframe');
      ifr.setAttribute('title', 'print-frame');
      Object.assign(ifr.style, { position:'fixed', right:'0', bottom:'0', width:'1px', height:'1px', border:'0', visibility:'hidden' });
      ifr.srcdoc = html;
      document.body.appendChild(ifr);

      const onReady = () => {
        const cw = ifr.contentWindow, cd = ifr.contentDocument;
        const finish = () => { try { cw.focus(); cw.print(); } finally { setTimeout(()=>{ try{ document.body.removeChild(ifr); }catch(_){} }, 1500); } };
        const imgs = Array.from(cd.images || []);
        if(imgs.length){
          Promise.all(imgs.map(i => (i.decode ? i.decode() : (i.complete ? Promise.resolve() : new Promise(r => i.onload = r)))))
            .then(()=> setTimeout(finish, 50))
            .catch(()=> setTimeout(finish, 100));
        } else { setTimeout(finish, 50); }
      };
      ifr.addEventListener('load', onReady);
    }

    /* ========= Study mode ========= */
    let studyIndex = 0; let studyOrder = [];
    function openStudy(){ if(!cards.length) return; studyOrder = cards.map(c=>c.id); studyIndex=0; $('#studyOverlay').classList.remove('hidden'); renderStudyCard(); $('#studyCard').focus(); }
    function closeStudy(){ $('#studyOverlay').classList.add('hidden'); }
    function renderStudyCard(){ const id = studyOrder[studyIndex]; const card = cards.find(c=>c.id===id);
      const host = document.getElementById('studyCard'); host.innerHTML=''; host.appendChild($('.flashcard', renderCard(card)));
      $('#progressTxt').textContent = `${studyIndex+1} / ${studyOrder.length}`;
    }
    function studyNext(){ if(studyIndex < studyOrder.length-1){ studyIndex++; renderStudyCard(); } }
    function studyPrev(){ if(studyIndex > 0){ studyIndex--; renderStudyCard(); } }

    /* ========= Duplicate ========= */
    function duplicateById(id){
      const idx = cards.findIndex(c=>c.id===id);
      if(idx < 0) return;
      const orig = cards[idx];
      const copy = JSON.parse(JSON.stringify(orig));
      copy.id = makeId();
      const baseTitle = (orig.title || 'Untitled').replace(/\s*\(copy\)+$/i,'').trim();
      copy.title = baseTitle + ' (copy)';
      cards.splice(idx+1, 0, copy);
      onDataChanged(); mountGrid(); selectForEdit(copy.id);
      const el = document.querySelector(`.card-wrap[data-id="${copy.id}"]`);
      el && el.scrollIntoView({ behavior:'smooth', block:'center' });
    }
    function duplicateSelected(){
      const id = selectedId || cards[0]?.id;
      if(!id){ alert('No card to duplicate.'); return; }
      duplicateById(id);
    }

    /* ========= Events & init ========= */
    function wireEvents(){
      document.getElementById('addCardBtn').addEventListener('click', ()=>{
        const c = defaultCard(); c.id = makeId(); c.title='New Process'; c.desc='';
        cards.unshift(c); onDataChanged(); mountGrid(); selectForEdit(c.id);
      });

      document.getElementById('duplicateBtn').addEventListener('click', (e)=>{ e.preventDefault(); e.stopPropagation(); duplicateSelected(); });

      // Delegate overlay duplicate clicks
      document.getElementById('cardsGrid').addEventListener('click', (e)=>{
        const btn = e.target.closest('.dup-overlay');
        if(!btn) return;
        e.preventDefault(); e.stopPropagation();
        const wrap = btn.closest('.card-wrap');
        const id = wrap?.dataset.id;
        if(id) duplicateById(id);
      });

      document.getElementById('studyBtn').addEventListener('click', openStudy);
      document.getElementById('closeStudyBtn').addEventListener('click', closeStudy);
      document.getElementById('flipStudyBtn').addEventListener('click', ()=> $('#studyCard .flashcard')?.classList.toggle('is-flipped'));
      document.getElementById('nextBtn').addEventListener('click', ()=>{ if(!$('#studyOverlay').classList.contains('hidden')) studyNext(); });
      document.getElementById('prevBtn').addEventListener('click', ()=>{ if(!$('#studyOverlay').classList.contains('hidden')) studyPrev(); });
      document.addEventListener('keydown', (e)=>{ if($('#studyOverlay').classList.contains('hidden')) return;
        if(e.key==='ArrowRight') studyNext();
        if(e.key==='ArrowLeft') studyPrev();
        if(e.code==='Space'){ e.preventDefault(); $('#studyCard .flashcard')?.classList.toggle('is-flipped'); }
        if(e.key==='Escape') closeStudy();
      });

      document.getElementById('printSelectedBtn').addEventListener('click', (e)=>{ e.preventDefault(); e.stopPropagation(); printCurrent(); });

      document.getElementById('saveCardBtn').addEventListener('click', ()=>{
        if(!selectedId){ selectedId = cards[0]?.id; }
        const idx = cards.findIndex(c=>c.id===selectedId); if(idx===-1) return;
        const updates = gatherEditor(); cards[idx] = { ...cards[idx], ...updates };
        _state.iconImg=''; _state.qrImg=''; onDataChanged(); mountGrid(); highlightSelected();
      });

      document.getElementById('deleteCardBtn').addEventListener('click', ()=>{
        if(!selectedId) return;
        cards = cards.filter(c=>c.id!==selectedId); selectedId = cards[0]?.id || null;
        onDataChanged(); mountGrid(); if(selectedId) selectForEdit(selectedId);
      });

      // ----- Size presets (per card) -----
      const presetEl = document.getElementById('f_sizePreset');
      const wEl = document.getElementById('f_cardW');
      const hEl = document.getElementById('f_cardH');
      const lockEl = document.getElementById('f_lockRatio');

      const presets = {
        default: { cardW: 360, cardH: 540 },
        small:   { cardW: 320, cardH: 480 },
        medium:  { cardW: 400, cardH: 600 },
        large:   { cardW: 450, cardH: 675 },
      };

      function applyPresetToSelected(name){
        if (!selectedId) return;
        const idx = cards.findIndex(c=>c.id===selectedId); if (idx === -1) return;
        const card = cards[idx]; ensureSizeFields(card);
        if (presets[name]) {
          card.cardW = presets[name].cardW;
          card.cardH = presets[name].cardH;
          card.sizePreset = name;
          wEl.value = card.cardW; hEl.value = card.cardH;
          onDataChanged(); mountGrid(); selectForEdit(card.id);
        }
      }

      function syncHeightFromWidth(){
        if (!selectedId) return;
        const idx = cards.findIndex(c=>c.id===selectedId); if (idx === -1) return;
        const card = cards[idx]; ensureSizeFields(card);
        if (!lockEl.checked) return;
        const w = clampNum(wEl.value, 260, 800);
        const h = Math.round(w * 1.5);
        hEl.value = clampNum(h, 390, 1200);
      }
      function syncWidthFromHeight(){
        if (!selectedId) return;
        const idx = cards.findIndex(c=>c.id===selectedId); if (idx === -1) return;
        const card = cards[idx]; ensureSizeFields(card);
        if (!lockEl.checked) return;
        const h = clampNum(hEl.value, 390, 1200);
        const w = Math.round(h / 1.5);
        wEl.value = clampNum(w, 260, 800);
      }

      presetEl.addEventListener('change', e=>{
        const v = e.target.value;
        if (v === 'custom') return;
        applyPresetToSelected(v);
      });

      wEl.addEventListener('input', ()=>{ syncHeightFromWidth(); });
      hEl.addEventListener('input', ()=>{ syncWidthFromHeight(); });

      document.getElementById('applySizeBtn').addEventListener('click', ()=>{
        if (!selectedId) return;
        const idx = cards.findIndex(c=>c.id===selectedId); if (idx === -1) return;
        const card = cards[idx]; ensureSizeFields(card);
        const w = clampNum(wEl.value, 260, 800);
        const h = clampNum(hEl.value, 390, 1200);
        const lock = !!lockEl.checked;
        card.cardW = w; card.cardH = h; card.lockRatio = lock;
        card.sizePreset = 'custom';
        onDataChanged(); mountGrid(); selectForEdit(card.id);
        presetEl.value = 'custom';
      });

      document.getElementById('resetSizeBtn').addEventListener('click', ()=>{
        if (!selectedId) return;
        const idx = cards.findIndex(c=>c.id===selectedId); if (idx === -1) return;
        const card = cards[idx]; ensureSizeFields(card);
        card.cardW = DEFAULT_CARD_W;
        card.cardH = DEFAULT_CARD_H;
        card.lockRatio = true;
        card.sizePreset = 'default';
        onDataChanged(); mountGrid(); selectForEdit(card.id);
        presetEl.value = 'default';
      });

      // ----- Icon/QR & offsets live sync -----
      const syncPair = (idRange, idNum, min, max, fallback, liveApply) => {
        const clamp = v => Math.min(max, Math.max(min, Number(v ?? fallback)));
        const set = v => {
          const val = clamp(v);
          document.getElementById(idRange).value = val;
          document.getElementById(idNum).value = val;
          if (typeof liveApply === 'function') liveApply(val);
        };
        document.getElementById(idRange).addEventListener('input', e=> set(e.target.value));
        document.getElementById(idNum).addEventListener('input', e=> set(e.target.value));
        return set;
      };

      // Icon/QR sizes
      syncPair('f_iconSize','f_iconSizeNum',32,128,ICON_PX_FALLBACK);
      syncPair('f_qrSize','f_qrSizeNum',48,200,QR_PX_FALLBACK);

      // Live front offsets
      const applyLiveFrontTitle = (percent)=>{
        if (!selectedId) return;
        const el = document.querySelector(`.card-wrap[data-id="${selectedId}"] .frontTitle`);
        const card = cards.find(c=>c.id===selectedId); if(!el || !card) return;
        ensureSizeFields(card); el.style.transform = `translateY(${pctToPx(percent, card.cardH)}px)`;
      };
      const applyLiveFrontContent = (percent)=>{
        if (!selectedId) return;
        const el = document.querySelector(`.card-wrap[data-id="${selectedId}"] .front-content`);
        const card = cards.find(c=>c.id===selectedId); if(!el || !card) return;
        ensureSizeFields(card); el.style.transform = `translateY(${pctToPx(percent, card.cardH)}px)`;
      };
      const setFrontTitle = syncPair('f_frontTitleOffset','f_frontTitleOffsetNum',-40,40,FRONT_TITLE_OFFSET_DEFAULT, applyLiveFrontTitle);
      const setFrontContent = syncPair('f_frontContentOffset','f_frontContentOffsetNum',-40,40,FRONT_CONTENT_OFFSET_DEFAULT, applyLiveFrontContent);

      document.getElementById('resetFrontTitleOffset').addEventListener('click', ()=> setFrontTitle(FRONT_TITLE_OFFSET_DEFAULT));
      document.getElementById('resetFrontContentOffset').addEventListener('click', ()=> setFrontContent(FRONT_CONTENT_OFFSET_DEFAULT));

      // Live back offsets
      const applyLiveTitle = (percent)=>{
        if (!selectedId) return;
        const el = document.querySelector(`.card-wrap[data-id="${selectedId}"] .processTitle`);
        const card = cards.find(c=>c.id===selectedId); if(!el || !card) return;
        ensureSizeFields(card); el.style.transform = `translateY(${pctToPx(percent, card.cardH)}px)`;
      };
      const applyLiveContent = (percent)=>{
        if (!selectedId) return;
        const el = document.querySelector(`.card-wrap[data-id="${selectedId}"] .back-content`);
        const card = cards.find(c=>c.id===selectedId); if(!el || !card) return;
        ensureSizeFields(card); el.style.transform = `translateY(${pctToPx(percent, card.cardH)}px)`;
      };
      const setTitle = syncPair('f_titleOffset','f_titleOffsetNum',-40,40,TITLE_OFFSET_DEFAULT, applyLiveTitle);
      const setContent = syncPair('f_contentOffset','f_contentOffsetNum',-40,40,CONTENT_OFFSET_DEFAULT, applyLiveContent);

      document.getElementById('resetTitleOffset').addEventListener('click', ()=> setTitle(TITLE_OFFSET_DEFAULT));
      document.getElementById('resetContentOffset').addEventListener('click', ()=> setContent(CONTENT_OFFSET_DEFAULT));

      // uploads
      document.getElementById('f_iconUpload').addEventListener('change', (e)=>{
        const f=e.target.files[0]; if(!f) return;
        const r=new FileReader(); r.onload=()=>{
          _state.iconImg = r.result;
          const prev=document.getElementById('iconPreview'); prev.src=r.result; prev.classList.remove('hidden');
          document.getElementById('clearIconBtn').classList.remove('hidden');
        }; r.readAsDataURL(f);
      });
      document.getElementById('clearIconBtn').addEventListener('click', ()=>{
        _state.iconImg=''; const prev=document.getElementById('iconPreview'); prev.classList.add('hidden'); prev.removeAttribute('src');
      });

      document.getElementById('f_qrupload').addEventListener('change', (e)=>{
        const f=e.target.files[0]; if(!f) return;
        const r=new FileReader(); r.onload=()=>{
          _state.qrImg = r.result;
          const prev=document.getElementById('qrPreview'); prev.src=r.result; prev.classList.remove('hidden');
          document.getElementById('clearQrBtn').classList.remove('hidden');
        }; r.readAsDataURL(f);
      });
      document.getElementById('clearQrBtn').addEventListener('click', ()=>{
        _state.qrImg=''; const prev=document.getElementById('qrPreview'); prev.classList.add('hidden'); prev.removeAttribute('src');
      });

      // Self-tests
      document.getElementById('selfTestBtn').addEventListener('click', runSelfTests);
    }

    function runSelfTests(){
      const results = [];
      const ok = s=>results.push('✅ '+s);
      const fail=(s,e)=>results.push('❌ '+s+(e?': '+e:''));

      try { document.getElementById('printSelectedBtn') ? ok('Print button exists') : fail('Print button exists', 'not found'); } catch(e){ fail('Print button exists', e.message); }
      try { document.getElementById('duplicateBtn') ? ok('Toolbar duplicate exists') : fail('Toolbar duplicate exists', 'not found'); } catch(e){ fail('Toolbar duplicate exists', e.message); }
      try { const ov = document.querySelector('.dup-overlay'); ov ? ok('Per-card overlay duplicate exists') : fail('Per-card overlay duplicate', 'not found'); } catch(e){ fail('Per-card overlay duplicate', e.message); }
      try { const first = $('#cardsGrid .flashcard'); first ? ok('Card mounted') : fail('Card mounted', 'none'); } catch(e){ fail('Card mounted', e.message); }

      try {
        const wrap = document.querySelector('.card-wrap');
        if (wrap){
          const html = buildPrintHTML(wrap);
          if(html.startsWith('<!DOCTYPE html><html') && html.endsWith('</html>')) ok('Print HTML well-formed'); else fail('Print HTML well-formed');
          (html.match(/class="paper"/g)||[]).length===2 ? ok('Two Letter pages (front/back)') : fail('Two Letter pages');
          html.includes('--safe:') ? ok('Safe inset present') : fail('Safe inset missing');
        }
      } catch(e){ fail('Print checks', e.message); }

      const box = document.getElementById('diagnostics'); if(box){ box.classList.remove('hidden'); box.style.whiteSpace='pre-wrap'; box.textContent = results.join('\n'); }
      console.log('[SelfTests]', results);
    }

    function init(){
      try {
        applySystemDarkMode();
        loadFromLocal();
        mountGrid();
        if (cards[0]) selectForEdit(cards[0].id);
        wireEvents();
      } catch (e) {
        console.error('Init failed:', e);
        const box = document.getElementById('diagnostics');
        if (box) { box.classList.remove('hidden'); box.textContent = 'Init error: ' + (e?.message || e); }
      }
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init, { once: true });
    } else {
      init();
    }
  </script>
</body>
</html>
